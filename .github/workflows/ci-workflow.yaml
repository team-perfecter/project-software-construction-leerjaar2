name: Run Tests, Create Reports, Send Webhook

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev, workflow/tests ]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, '[skip tests]') }}
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: database
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r api/requirements.txt
        pip install pytest pytest-cov

    - name: Run unit tests
      run: |
        pytest api/tests/unit/ -v --cov=api --cov-report=xml:coverage-unit.xml --cov-report=term
      env:
        PGHOST: localhost
        PGPORT: 5432

    - name: Upload unit test coverage
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-unit
        path: coverage-unit.xml

  integration-tests:
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, '[skip tests]') }}
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: database
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r api/requirements.txt
        pip install pytest pytest-cov

    - name: Run integration tests
      run: |
        pytest api/tests/integration/ -v --cov=api --cov-report=xml:coverage-integration.xml --cov-report=term
      env:
        PGHOST: localhost
        PGPORT: 5432

    - name: Upload integration test coverage
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-integration
        path: coverage-integration.xml

  performance-tests:
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, '[skip tests]') }}
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: database
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r api/requirements.txt
        pip install pytest pytest-benchmark

    - name: Run performance tests
      run: |
        pytest api/tests/performance/ -v --benchmark-only --benchmark-json=benchmark-results.json
      env:
        PGHOST: localhost
        PGPORT: 5432

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: benchmark-results
        path: benchmark-results.json

  # report:
  #   runs-on: ubuntu-latest
  #   needs: [unit-tests, integration-tests, performance-tests]
  #   if: always()
  #   steps:
  #     - name: Download all artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         path: ./artifacts

  #     - name: Generate test report
  #       run: |
  #         echo "Test Report Summary" > test-report.txt
  #         echo "==================" >> test-report.txt
  #         echo "" >> test-report.txt
          
  #         if [ -f "./artifacts/coverage-unit/coverage-unit.xml" ]; then
  #           echo "✓ Unit tests completed" >> test-report.txt
  #         else
  #           echo "✗ Unit tests failed" >> test-report.txt
  #         fi
          
  #         if [ -f "./artifacts/coverage-integration/coverage-integration.xml" ]; then
  #           echo "✓ Integration tests completed" >> test-report.txt
  #         else
  #           echo "✗ Integration tests failed" >> test-report.txt
  #         fi
          
  #         if [ -f "./artifacts/benchmark-results/benchmark-results.json" ]; then
  #           echo "✓ Performance tests completed" >> test-report.txt
  #         else
  #           echo "✗ Performance tests failed" >> test-report.txt
  #         fi
          
  #         cat test-report.txt

  #     - name: Upload test report
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: test-report
  #         path: test-report.txt

  # webhook:
  #   runs-on: ubuntu-latest
  #   needs: [unit-tests, integration-tests, performance-tests, report]
  #   if: always()
  #   steps:
  #     - name: Determine test status
  #       id: test-status
  #       run: |
  #         if [ "${{ needs.unit-tests.result }}" == "success" ] && \
  #            [ "${{ needs.integration-tests.result }}" == "success" ] && \
  #            [ "${{ needs.performance-tests.result }}" == "success" ]; then
  #           echo "status=success" >> $GITHUB_OUTPUT
  #         else
  #           echo "status=failure" >> $GITHUB_OUTPUT
  #         fi

  #     - name: Send webhook notification
  #       run: |
  #         echo "Would send webhook with status: ${{ steps.test-status.outputs.status }}"
  #         echo "Unit tests: ${{ needs.unit-tests.result }}"
  #         echo "Integration tests: ${{ needs.integration-tests.result }}"
  #         echo "Performance tests: ${{ needs.performance-tests.result }}"