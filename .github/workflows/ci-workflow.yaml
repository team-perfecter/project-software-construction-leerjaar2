name: Run Tests, Create Reports, Send Webhook

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev, workflow/tests ]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, '[skip tests]') }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Start services with Docker Compose
      run: docker compose up -d db db_migration

    - name: Wait for database
      run: |
        until docker compose exec -T db pg_isready -U user -d database; do
          echo "Waiting for database..."
          sleep 2
        done

    - name: Run unit tests
      run: |
        docker compose run --rm -v ${PWD}:/app parking-api \
          pytest /app/api/tests/unit/ \
          --cov=api \
          --cov-report=xml:/app/coverage-unit.xml \
          --cov-report=term \
          -v

    - name: Upload unit test coverage
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-unit
        path: coverage-unit.xml

    - name: Stop services
      if: always()
      run: docker compose down -v

  integration-tests:
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, '[skip tests]') }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Start services with Docker Compose
      run: docker compose up -d db db_migration

    - name: Wait for database
      run: |
        until docker compose exec -T db pg_isready -U user -d database; do
          echo "Waiting for database..."
          sleep 2
        done

    - name: Run integration tests
      run: |
        docker compose run --rm -v ${PWD}:/app parking-api \
          pytest /app/api/tests/integration/ \
          --cov=api \
          --cov-report=xml:/app/coverage-integration.xml \
          --cov-report=term \
          -v

    - name: Upload integration test coverage
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-integration
        path: coverage-integration.xml

    - name: Stop services
      if: always()
      run: docker compose down -v

  performance-tests:
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, '[skip tests]') }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Start services with Docker Compose
      run: docker compose up -d db db_migration

    - name: Wait for database
      run: |
        until docker compose exec -T db pg_isready -U user -d database; do
          echo "Waiting for database..."
          sleep 2
        done

    - name: Run performance tests
      run: |
        docker compose run --rm -v ${PWD}:/app parking-api \
          pytest /app/api/tests/performance/ \
          --benchmark-only \
          --benchmark-json=/app/benchmark-results.json \
          -v

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: benchmark-results
        path: benchmark-results.json

    - name: Stop services
      if: always()
      run: docker compose down -v

  # report:
  #   runs-on: ubuntu-latest
  #   needs: [unit-tests, integration-tests, performance-tests]
  #   if: always()
  #   steps:
  #     - name: Download all artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         path: ./artifacts

  #     - name: Generate test report
  #       run: |
  #         echo "Test Report Summary" > test-report.txt
  #         echo "==================" >> test-report.txt
  #         echo "" >> test-report.txt
          
  #         if [ -f "./artifacts/coverage-unit/coverage-unit.xml" ]; then
  #           echo "✓ Unit tests completed" >> test-report.txt
  #         else
  #           echo "✗ Unit tests failed" >> test-report.txt
  #         fi
          
  #         if [ -f "./artifacts/coverage-integration/coverage-integration.xml" ]; then
  #           echo "✓ Integration tests completed" >> test-report.txt
  #         else
  #           echo "✗ Integration tests failed" >> test-report.txt
  #         fi
          
  #         if [ -f "./artifacts/benchmark-results/benchmark-results.json" ]; then
  #           echo "✓ Performance tests completed" >> test-report.txt
  #         else
  #           echo "✗ Performance tests failed" >> test-report.txt
  #         fi
          
  #         cat test-report.txt

  #     - name: Upload test report
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: test-report
  #         path: test-report.txt

  # webhook:
  #   runs-on: ubuntu-latest
  #   needs: [unit-tests, integration-tests, performance-tests, report]
  #   if: always()
  #   steps:
  #     - name: Determine test status
  #       id: test-status
  #       run: |
  #         if [ "${{ needs.unit-tests.result }}" == "success" ] && \
  #            [ "${{ needs.integration-tests.result }}" == "success" ] && \
  #            [ "${{ needs.performance-tests.result }}" == "success" ]; then
  #           echo "status=success" >> $GITHUB_OUTPUT
  #         else
  #           echo "status=failure" >> $GITHUB_OUTPUT
  #         fi

  #     - name: Send webhook notification
  #       run: |
  #         echo "Would send webhook with status: ${{ steps.test-status.outputs.status }}"
  #         echo "Unit tests: ${{ needs.unit-tests.result }}"
  #         echo "Integration tests: ${{ needs.integration-tests.result }}"
  #         echo "Performance tests: ${{ needs.performance-tests.result }}"