services:
  parking-api:
    environment:
      MIGRATE_JSON: "true"
      LOG_FILE: /var/log/parking-api/app.log
    build:
      context: ./api
    ports:
      - "8000:8000"
    depends_on:
      db_migration:
        condition: service_completed_successfully
    restart: always
    environment:
      LOG_FILE: /var/log/parking-api/app.log
      SECRET_KEY: super_secret_key 
    volumes:
      - ./logs:/var/log/parking-api

  db_migration:
    build:
      context: ./database
    depends_on:
      db:
        condition: service_healthy
    command: ["python", "migrate.py"]
    restart: "no"

  db_migration_test:
   build:
     context: ./database
   depends_on:
     - test_db
   command: [ "python", "migrate.py", "test_database" ]
 
  db:
    image: postgres:16
    container_name: postgres
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: database
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d database"]
      interval: 5s
      retries: 5
      timeout: 5s
      start_period: 10s

  test_db:
   image: postgres:16
   container_name: postgres_test
   restart: always
   environment:
     POSTGRES_USER: user
     POSTGRES_PASSWORD: password
     POSTGRES_DB: test_database
   ports:
     - "5433:5432"

volumes:
  postgres-data:
  test-db-data: